{% extends "base.html" %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-md-8 col-lg-6">
        <h2 class="text-center mt-3">Attendance Scanner</h2>

        <div class="card mt-4">
            <div class="card-body text-center">
                <div id="scanner-container">
                    <div id="reader"></div>
                    <div id="status-message" class="alert d-none mt-3"></div>
                </div>

                <div class="mt-3">
                    <p class="text-muted"><small>Ensure GPS is enabled.</small></p>
                    <button class="btn btn-primary" id="start-scan-btn">Start Camera</button>
                    <button class="btn btn-secondary d-none" id="stop-scan-btn">Stop Camera</button>
                </div>
            </div>
            <div class="card-footer">
                <h5>Recent Activity</h5>
                <ul id="activity-log" class="list-group list-group-flush small">
                    <li class="list-group-item text-muted">No recent activity.</li>
                </ul>
            </div>
        </div>
    </div>
</div>

<!-- HTML5-QRCode Library -->
<script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>

<script>
    let html5QrcodeScanner;

    document.getElementById('start-scan-btn').addEventListener('click', function () {
        startScanner();
    });

    document.getElementById('stop-scan-btn').addEventListener('click', function () {
        if (html5QrcodeScanner) {
            html5QrcodeScanner.clear();
            document.getElementById('start-scan-btn').classList.remove('d-none');
            document.getElementById('stop-scan-btn').classList.add('d-none');
        }
    });

    function startScanner() {
        if (!navigator.geolocation) {
            showStatus("Geolocation is not supported by this browser.", "danger");
            return;
        }

        document.getElementById('start-scan-btn').classList.add('d-none');
        document.getElementById('stop-scan-btn').classList.remove('d-none');

        const formatsToSupport = [Html5QrcodeSupportedFormats.QR_CODE];
        html5QrcodeScanner = new Html5QrcodeScanner(
            "reader",
            { fps: 10, qrbox: { width: 250, height: 250 }, formatsToSupport: formatsToSupport },
            /* verbose= */ false
        );

        html5QrcodeScanner.render(onScanSuccess, onScanFailure);
    }

    function onScanSuccess(decodedText, decodedResult) {
        // Handle the scanned code
        console.log(`Scan result: ${decodedText}`);
        html5QrcodeScanner.clear(); // Stop scanning

        showStatus("Processing...", "info");

        // Get GPS
        navigator.geolocation.getCurrentPosition(position => {
            const payload = {
                qr_code: decodedText,
                lat: position.coords.latitude,
                lon: position.coords.longitude,
                accuracy: position.coords.accuracy
            };

            sendScan(payload);

        }, error => {
            showStatus("GPS Error: " + error.message, "danger");
            html5QrcodeScanner.render(onScanSuccess, onScanFailure); // Restart
        }, {
            enableHighAccuracy: true,
            timeout: 5000,
            maximumAge: 0
        });
    }

    function onScanFailure(error) {
        // handle scan failure, usually better to ignore and keep scanning.
        // console.warn(`Code scan error = ${error}`);
    }

    function sendScan(payload) {
        fetch('{{ url_for("scanner_bp.scan_endpoint") }}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(payload)
        })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    showStatus(data.message, 'success');
                    addLogEntry(data.message, data.timestamp);
                } else {
                    showStatus(data.message, 'danger');
                }
            })
            .catch(error => {
                showStatus('Network error.', 'danger');
            });
    }

    function showStatus(msg, type) {
        const el = document.getElementById('status-message');
        el.textContent = msg;
        el.className = `alert alert-${type} mt-3`;
        el.classList.remove('d-none');
    }

    function addLogEntry(msg, time) {
        const ul = document.getElementById('activity-log');
        const li = document.createElement('li');
        li.className = 'list-group-item';
        li.textContent = `${time}: ${msg}`;
        ul.prepend(li);
    }
</script>
{% endblock %}